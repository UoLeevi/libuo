#include "uo_base64.h"

#include <stdint.h>

static const unsigned char btoa[64] = {
//        0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07 0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x0F
/* 0x00 */ 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P',
/* 0x10 */ 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', 'a', 'b', 'c', 'd', 'e', 'f',
/* 0x20 */ 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v',
/* 0x30 */ 'w', 'x', 'y', 'z', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '+', '/' };

static const unsigned char atob[256] = {
//        0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07 0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x0F
/* 0x00 */0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
/* 0x10 */0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
/* 0x20 */0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x3E,0xFF,0xFF,0xFF,0x3F,
/* 0x30 */0x34,0x35,0x36,0x37,0x38,0x39,0x3A,0x3B,0x3C,0x3D,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
/* 0x40 */0xFF,0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,
/* 0x50 */0x0F,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0xFF,0xFF,0xFF,0xFF,0xFF,
/* 0x60 */0xFF,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,
/* 0x70 */0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,0x30,0x31,0x32,0x33,0xFF,0xFF,0xFF,0xFF,0xFF,
/* 0x80 */0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
/* 0x90 */0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
/* 0xA0 */0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
/* 0xB0 */0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
/* 0xC0 */0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
/* 0xD0 */0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
/* 0xE0 */0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
/* 0xF0 */0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF };

size_t uo_base64_len(
    size_t len)
{
    return (len * 4 / 3 + 3) & ~3;
}

char *uo_base64_encode(
    char *dst, 
    const void *src, 
    size_t src_len)
{
    char *end = dst + ((src_len * 4 / 3 + 3) & ~3);
    char *a = (unsigned char *)end;
    const unsigned char *b = (unsigned char *)src + src_len;
    unsigned char b0, b1, b2;

    switch (src_len % 3)
    {
        case 1:
            b0 = *--b;

            *--a = '=';
            *--a = '=';
            *--a = btoa[(b0 & 0x03) << 4];
            *--a = btoa[b0 >> 2];

            break;

        case 2:
            b1 = *--b;
            b0 = *--b;
            
            *--a = '=';
            *--a = btoa[(b1 & 0x0F) << 2];
            *--a = btoa[(b0 & 0x03) << 4 | b1 >> 4];
            *--a = btoa[b0 >> 2];

            break;
    }

    while ((char *)a >= dst)
    {
        b2 = *--b;
        b1 = *--b;
        b0 = *--b;
        
        *--a = btoa[b2 & 0x3F];
        *--a = btoa[(b1 & 0x0F) << 2 | b2 >> 6];
        *--a = btoa[(b0 & 0x03) << 4 | b1 >> 4];
        *--a = btoa[b0 >> 2];
    }

    return end;
}

void *uo_base64_decode(
    void *dst, 
    const char *src, 
    size_t src_len)
{
    unsigned char *b = (unsigned char *)dst;
    const unsigned char *a = (unsigned char *)src;
    const unsigned char *end = a + src_len;
    unsigned char a0, a1, a2, a3;

    while (a + 4 < end || a[2] != '=' && a[3] != '=')
    {
        a0 = atob[*a++];
        a1 = atob[*a++];
        a2 = atob[*a++];
        a3 = atob[*a++];

        *b++ = a0 << 2 | a1 >> 4;
        *b++ = (a1 & 0x0F) << 4 | a2 >> 2;
        *b++ = (a2 & 0x03) << 6 | a3;
    }

    if (a < end)
    {
        a0 = atob[*a++];
        a1 = atob[*a++];
        a2 = atob[*a++];

        *b++ = a0 << 2 | a1 >> 4;

        if (~a2)
        {
            *b++ = (a1 & 0x0F) << 4 | a2 >> 2;
        }
        else
        {
            *b++ = (a2 & 0x03) << 6;
            *b++ = (a1 & 0x0F) << 4;
        }
    }

    return b;
}
